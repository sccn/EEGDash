import glob
from argparse import ArgumentParser
from pathlib import Path

import pandas as pd


def prepare_table(df: pd.DataFrame):
    df["dataset"] = df["dataset"].apply(lambda x: f":class:`{x.upper()}`")
    # changing the column order
    df = df[
        [
            "dataset",
            "n_records",
            "n_subjects",
            "n_tasks",
            "duration_hours_total",
            "nchans_set",
            "sampling_freqs",
        ]
    ]

    # renaming time for something small
    df = df.rename(columns={"duration_hours_total": "duration (h)"})

    # number of subject are always int
    df["n_subjects"] = df["n_subjects"].astype(int)
    # number of tasks are always int
    df["n_tasks"] = df["n_tasks"].astype(int)
    # number of records are always int
    df["n_records"] = df["n_records"].astype(int)

    # from the sample frequency list, I will apply int
    df["sampling_freqs"] = df["sampling_freqs"].apply(parse_freqs)
    # clean repeat values of the sampling frequency
    df["sampling_freqs"] = df["sampling_freqs"].apply(lambda x: list(set(x)))
    # Creating the total line
    df.loc["Total"] = df.sum(numeric_only=True)
    df.loc["Total", "dataset"] = "Total"
    # arrounding the hours
    df["duration (h)"] = df["duration (h)"].round(2)

    df.index = df.index.astype(str)

    return df


def main(source_dir: str, target_dir: str):
    target_dir = Path(target_dir)
    target_dir.mkdir(parents=True, exist_ok=True)
    files = glob.glob(str(Path(source_dir) / "*.csv"))
    for f in files:
        target_file = target_dir / Path(f).name
        print(f"Processing {f} -> {target_file}")
        df = pd.read_csv(f, index_col=False, header=0, skipinitialspace=True)
        df = prepare_table(df)
        # preserve int values
        df["n_subjects"] = df["n_subjects"].astype(int)
        df["n_tasks"] = df["n_tasks"].astype(int)
        df["n_records"] = df["n_records"].astype(int)

        int_cols = ["n_subjects", "n_tasks", "n_records"]

        # Coerce to numeric, allow NAs, and keep integer display
        df[int_cols] = (
            df[int_cols].apply(pd.to_numeric, errors="coerce").astype("Int64")
        )

        # (If you add a 'Total' row after this, cast again or build it as Int64.)
        df.to_csv(target_file, index=False, na_rep="")


def parse_freqs(value):
    if isinstance(value, str):
        return [int(float(f)) for f in value.strip("[]").split(",")]
    elif isinstance(value, (int, float)) and not pd.isna(value):
        return [int(value)]
    return []  # for other types like nan


if __name__ == "__main__":
    parser = ArgumentParser()
    parser.add_argument("source_dir", type=str)
    parser.add_argument("target_dir", type=str)
    args = parser.parse_args()
    main(args.source_dir, args.target_dir)
    print(args.target_dir)
