name: Fetch OpenNeuro & NEMAR Datasets

on:
  pull_request:
    branches:
      - '**'
  # schedule:
  #   # Run weekly on Monday at 00:00 UTC
  #   - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual triggering

jobs:
  fetch-datasets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gql[requests] requests

      - name: Fetch OpenNeuro datasets
        run: |
          python scripts/ingestions/1_fetch_openneuro_datasets.py \
            --page-size 100 \
            --output consolidated/openneuro_datasets.json

      - name: Fetch NEMAR GitHub repositories
        run: |
          python scripts/ingestions/1_fetch_github_organization.py \
            --organization nemardatasets \
            --output consolidated/nemardatasets_repos.json

      - name: Verify OpenNeuro output
        run: |
          if [ -f consolidated/openneuro_datasets.json ]; then
            echo "✓ OpenNeuro dataset file created successfully"
            python -c "import json; data = json.load(open('consolidated/openneuro_datasets.json')); print(f'Total entries: {len(data)}'); modalities = set(d['modality'] for d in data); print(f'Modalities: {sorted(modalities)}')"
          else
            echo "✗ OpenNeuro dataset file not created"
            exit 1
          fi

      - name: Verify NEMAR output
        run: |
          if [ -f consolidated/nemardatasets_repos.json ]; then
            echo "✓ NEMAR repositories file created successfully"
            python -c "import json; data = json.load(open('consolidated/nemardatasets_repos.json')); print(f'Total repositories: {len(data)}'); topics = set(); [topics.update(d.get('topics', [])) for d in data]; print(f'Topics: {sorted(topics) if topics else \"None\"}')"
          else
            echo "✗ NEMAR repositories file not created"
            exit 1
          fi

      - name: Commit changes if datasets updated
        uses: EndBug/add-and-commit@v9
        with:
          default_author: github_actions
          message: 'chore: update OpenNeuro & NEMAR dataset listings'
          add: |
            consolidated/openneuro_datasets.json
            consolidated/nemardatasets_repos.json
          pull: '--rebase --autostash'
          push: true
        if: always()

      - name: Upload artifacts for downstream jobs
        uses: actions/upload-artifact@v4
        with:
          name: dataset-listings
          path: |
            consolidated/openneuro_datasets.json
            consolidated/nemardatasets_repos.json
          retention-days: 7
